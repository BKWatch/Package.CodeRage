#!/bin/sh

################################################################################
#
# Defines function used by CodeRage shell scripts
#
# File:        CodeRage/Build/Resource/run-coderage
# Date:        Sat Sep 27 11:44:33 MDT 2008
# Notice:      This document contains confidential information and
#              trade secrets
#
# Copyright:   2015 CounselNow, LLC
# Author:      Jonathan Turkanis
# License:     All rights reserved
#
################################################################################

# Globals
coderage_files="Bin CodeRage.php"

    ####################
    # findtools
    ####################

# Outputs the path of the directory containing the CodeRage bootstrap files
findtools()
{
    local php include path

    # Fetch PHP command-line executable
    php=$(findphp) || return 1

    # Fetch PHP include path
    include=$(php -r "echo ini_get('include_path');")

    eval set -- \"$(echo "$include" | sed -e's/:/" "/g')\"
    for path in "$@" ; do
        if testpath "$path" ; then
            echo "$path"
            return 0
        fi
    done
    exit 1
}

    ####################
    # findphp
    ####################

# Returns path of the PHP command-line-executable
findphp()
{
    local php=$(which php)
    if [ -z "$php" ] ; then
        echo "Can't find PHP command-line executable." \
            "Please add it to your PATH." >&2
        return 1
    fi
    local sapi=$("$php" -r "echo php_sapi_name();")
    if [ "$sapi" != "cli" ] ; then
        echo "Program '$php' in PATH is not the PHP command-line" \
            "executable." >&2
        return 1
    fi
    echo "$php"
}

    ####################
    # testpath
    ####################

# Usage: test-path path
# Returns 0 if the given path is the root directory of the CodeRage shared tools
testpath()
{
    local path="$1" file
    for file in $coderage_files ; do
        if ! [ -e "$path/$file" ] ; then
            return 1
        fi
    done
    return 0
}

    ####################
    # Script Body
    ####################


tool="$1"
shift

if ! path=$(findtools) ; then
    echo "Can't find CodeRage tools in PHP include path" >&2
    exit
fi

php "$path/Bin/$tool.php" "$@"
